<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr-fr" itemscope="" itemtype="http://schema.org/Blog">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="description" content="Blog sur la qualité web en général, et l'automatisation de test web en particulier. Responsable tests et qualité web depuis 7 ans." />
  <meta name="keywords" content="test, watir, qualité, cucumber, jenkins, bug, selenium, appium" />
  <meta name="robots" content="index,follow" />

  <title>
    
      Ruby - OAuth v1.0a pour optimiser les tests &middot; Je teste donc je suis
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700">

  <!-- Icons --
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">-->
                <link rel="shortcut icon" type="image/png" href="/public/qualite.jpg">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
  <link rel="stylesheet" href="/public/fancybox/jquery.fancybox.css" type="text/css" media="screen" />
  <script type="text/javascript" src="/public/fancybox/jquery.fancybox.pack.js"></script>

  <meta property="og:image"  content="/public/pictures/web-qualite.jpg"/>
  <meta itemprop="image"     content="/public/pictures/web-qualite.jpg" />
  <meta name="twitter:image" content="/public/pictures/web-qualite.jpg" />  
</head>

  <body class="theme-base-0c layout-reverse">
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Je teste donc je suis
        </a>
      </h1>
      <p class="lead">Blog d'un automatiseur de tests web.</p>
    </div>

    <nav class="sidebar-nav">
      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
	  <a class="sidebar-nav-item" href="http://www.fabricebournisien.eu">CV</a>
	  <!-- SiteSearch Google --> 
	  <form method="get" action="http://www.google.com/search"> <input type="hidden" name="ie" value="UTF-8" /> 
		<input type="hidden" name="oe" value="UTF-8" /> 
		<input type="hidden" name="domains" value="blog.fabricebournisien.eu" /> 
		<input type="hidden" name="sitesearch" value="blog.fabricebournisien.eu" checked="checked" />
		<input type="text" name="q" size="18" maxlength="255" value="" />
		<input type="submit" name="btnG" value="Chercher" /> 
	  </form>
	  <!-- SiteSearch Google -->
    </nav>

    <p>&copy; 2014 - <a href="https://plus.google.com/104493142924184161356" rel="author">Fabrice Bournisien</a></p>
  </div>
</div>

    <div class="content container">
      <div class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <h1 class="post-title" itemprop="name">Ruby - OAuth v1.0a pour optimiser les tests</h1>
  <span class="post-date">
	  <time class="date" datetime="2013-06-10" itemprop="datePublished">
		10/06/2013
	  </time>
	  - par Fabrice Bournisien
		
		- <a href="/tag/ruby">Ruby</a>
		
		- <a href="/tag/tests">Tests</a>
		
		- <a href="/tag/api">Api</a>
		
		- <a href="/tag/watir">Watir</a>
		
  </span>

	<div itemprop="ArticleBody"><p>Lors de tests, il arrive souvent qu&#39;on ait besoin de &quot;faire le ménage&quot; pour retrouver un état comme à l&#39;origine.
Plusieurs stratégies possibles, en fonction des technologies qu&#39;on souhaite utiliser.</p>

<h3>Un par un, à la fin</h3>

<p>Après chaque scénario, supprimer ce qui a été ajouté, annuler les modifications une par une.</p>

<p>Avantages : </p>

<ul>
<li>Facile à mettre en place (on réutilise ce qui a déjà été fait)</li>
</ul>

<p>Défauts : </p>

<ul>
<li>Si le scénario plante, on ne remet pas en l&#39;état</li>
<li>Chaque scénario prend un peu plus de temps (jusqu&#39;au double, dans le pire des cas)</li>
</ul>

<h3>Un par un, au début</h3>

<p>Avant chaque scénario, remettre les valeurs par défauts pour le test</p>

<p>Avantages :</p>

<ul>
<li>Facile à mettre en place (on réutilise ce qui a déjà été fait)</li>
</ul>

<p>Défauts :</p>

<ul>
<li>Si la remise à zéro ne marche pas, on ne teste pas</li>
<li>Chaque scénario prend un peu plus de temps (jusqu&#39;au double, dans le pire des cas)</li>
</ul>

<h3>Tous d&#39;un coup, dans une routine à part</h3>

<p>Puisqu&#39;on utilise un outil comme jenkins pour organiser tous les tests, on peut ajouter une routine &quot;à part&quot;, qui va se connecter sur chaque compte pour effectuer cette remise à zéro.</p>

<p>Avantages :</p>

<ul>
<li>Toutes les procédures de remises à zéro sont au même endroit</li>
</ul>

<p>Défauts :</p>

<ul>
<li>Un peu plus long à mettre en place</li>
<li>Demande d&#39;ajouter une sécurité pour ne pas la lancer au mauvais moment</li>
<li>Ca prend du temps (mais autant que de le faire un par un)</li>
</ul>

<h3>Optimisation : utilisation d&#39;une API</h3>

<p>Dans mon cas, nous disposons aussi d&#39;une API publique (en alpha, elle n&#39;est pas encore ouverte à tout le monde)</p>

<p>Avantages :</p>

<ul>
<li>Pas d&#39;interface web, cela devrait aller plus vite</li>
<li>Ajoutera &quot;en passant&quot; des tests sur la public API</li>
</ul>

<p>Défauts :</p>

<ul>
<li>Je ne maitrise pas du tout Oauth 1.0a (ça me permettra d&#39;apprendre : tant mieux)</li>
<li>Nous disposons d&#39;un SDK pour faciliter l&#39;utilisation de l&#39;API, en php. Pour des raisons pratiques, je préfère le faire en ruby, le serveur de tests étant déjà configuré pour cela. Je pars donc &quot;de zéro&quot;</li>
</ul>

<h3>Utiliser une API OAuth 1.0a en Ruby</h3>

<p>On trouve un peu de documentation pour le faire, et quelques exemples. Quelques remarques sur ces articles :
* La quasi totalité expose le même code d&#39;exemple.
* Rares sont ceux qui signalent la version d&#39;OAuth
* Les exemples se concentrent beaucoup sur &quot;comment se connecter à l&#39;api&quot;, et très rarement sur &quot;comment l&#39;utiliser&quot;</p>

<p>Voilà quelques astuces pour utiliser &quot;rapidement&quot; une API OAuth en ruby</p>

<h4>Utilisation de gems</h4>

<p>Elles facilitent la vie, autant en profiter.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'oauth'</span>
<span class="nb">require</span> <span class="s1">'watir-webdriver'</span>
<span class="nb">require</span> <span class="s1">'json'</span>
</code></pre></div>
<h4>Définition de constantes de l&#39;api</h4>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">OB_API_SERVER</span>                 <span class="o">=</span> <span class="s1">'http://url_server_api'</span>
<span class="no">OB_API_BASE_URL</span>               <span class="o">=</span> <span class="no">OB_API_SERVER</span><span class="o">+</span><span class="s1">'/public/0.1'</span>
<span class="no">OB_API_ENDPOINT_REQUEST_TOKEN</span> <span class="o">=</span> <span class="s1">'/oauth/request_token'</span>
<span class="no">OB_API_ENDPOINT_ACCESS_TOKEN</span>  <span class="o">=</span> <span class="s1">'/oauth/access_token'</span>
<span class="no">OB_API_ENDPOINT_AUTHORIZE</span>     <span class="o">=</span> <span class="s1">'/oauth/authorize'</span>
<span class="no">OB_API_MY_CONSUMER_KEY</span>        <span class="o">=</span> <span class="s1">'######'</span>
<span class="no">OB_API_MY_CONSUMER_SECRET</span>     <span class="o">=</span> <span class="s1">'######'</span>
</code></pre></div>
<p>Obtenir la connexion à l&#39;API</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># create the OAuth consumer</span>
<span class="vi">@consumer</span> <span class="o">=</span> <span class="no">OAuth</span><span class="o">::</span><span class="no">Consumer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span> 
    <span class="no">OB_API_MY_CONSUMER_KEY</span><span class="p">,</span>
    <span class="no">OB_API_MY_CONSUMER_SECRET</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="ss">:oauth_version</span>      <span class="o">=&gt;</span> <span class="s1">'1.0a'</span><span class="p">,</span>
        <span class="ss">:site</span>               <span class="o">=&gt;</span> <span class="no">OB_API_SERVER</span><span class="p">,</span>
        <span class="ss">:request_token_path</span> <span class="o">=&gt;</span> <span class="no">OB_API_ENDPOINT_REQUEST_TOKEN</span><span class="p">,</span>
        <span class="ss">:access_token_path</span>  <span class="o">=&gt;</span> <span class="no">OB_API_ENDPOINT_ACCESS_TOKEN</span><span class="p">,</span>
        <span class="ss">:authorize_path</span>     <span class="o">=&gt;</span> <span class="no">OB_API_ENDPOINT_AUTHORIZE</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="c1"># show all debugs in console</span>
<span class="c1"># @consumer.http.set_debug_output($stdout)</span>
<span class="c1"># get the authorize url</span>
<span class="vi">@request_token</span> <span class="o">=</span> <span class="vi">@consumer</span><span class="p">.</span><span class="nf">get_request_token</span>
<span class="c1"># Make as if the user authorize the app</span>
<span class="c1"># If you make a web app, you should show the link to your user, and let it click it</span>
<span class="c1"># browse the authorize url</span>
<span class="vi">@browser</span> <span class="o">=</span> <span class="no">Watir</span><span class="o">::</span><span class="no">Browser</span><span class="p">.</span><span class="nf">new</span>
<span class="vi">@browser</span><span class="p">.</span><span class="nf">goto</span><span class="p">(</span><span class="vi">@request_token</span><span class="p">.</span><span class="nf">authorize_url</span><span class="p">())</span>
<span class="c1"># connect with account</span>
<span class="vi">@browser</span><span class="p">.</span><span class="nf">text_field</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'email'</span><span class="p">).</span><span class="nf">set</span><span class="p">(</span><span class="s2">"test@test.fr"</span><span class="p">)</span>
<span class="vi">@browser</span><span class="p">.</span><span class="nf">text_field</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'passwd'</span><span class="p">).</span><span class="nf">set</span><span class="p">(</span><span class="s2">"monmotdepasse"</span><span class="p">)</span>
<span class="vi">@browser</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'loginSubmit'</span><span class="p">).</span><span class="nf">click</span>
<span class="c1"># give access</span>
<span class="vi">@browser</span><span class="p">.</span><span class="nf">form</span><span class="p">.</span><span class="nf">submit</span>
<span class="c1"># get verifier token</span>
<span class="c1"># browser url contain oauth_verifier_token</span>
<span class="n">oauth_verifier_token</span> <span class="o">=</span> <span class="vi">@browser</span><span class="p">.</span><span class="nf">url</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"oauth_verifier="</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="c1"># grant total access</span>
<span class="vi">@access_token</span> <span class="o">=</span> <span class="vi">@request_token</span><span class="p">.</span><span class="nf">get_access_token</span><span class="p">(</span><span class="ss">:oauth_verifier</span> <span class="o">=&gt;</span> <span class="n">oauth_verifier_token</span><span class="p">)</span>
<span class="c1"># no more browser needed</span>
<span class="vi">@browser</span><span class="p">.</span><span class="nf">close</span>
</code></pre></div>
<h4>Exemples d&#39;utilisation de l&#39;API OAuth</h4>

<p>Une fois qu&#39;on est connecté à l&#39;API, on peut l&#39;utiliser. Il faut lire sa documentation, en général assez touffue, pour savoir ce qu&#39;on peut faire (lister / ajouter / modifier / supprimer).
Voici deux exemples &quot;simplifiés&quot; pour mon exemple.</p>

<h5>Classique</h5>

<p>Afficher les informations sur le blog courant.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">get_url_info</span> <span class="o">=</span>  <span class="no">OB_API_BASE_URL</span><span class="o">+</span><span class="s1">'/blog/info'</span>
<span class="n">current_blog_info</span> <span class="o">=</span> <span class="vi">@access_token</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">get_url_info</span><span class="p">)</span>
</code></pre></div>
<h5>Avec une option</h5>

<p>Afficher la liste des titres des articles en brouillons.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">get_lists_content</span> <span class="o">=</span> <span class="no">OB_API_BASE_URL</span><span class="o">+</span><span class="s1">'/blog/posts/draft?limit=20'</span>
<span class="n">content_list</span> <span class="o">=</span> <span class="vi">@access_token</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">get_lists_content</span><span class="p">)</span>
<span class="c1"># read json results</span>
<span class="n">result</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">content_list</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
<span class="n">result</span><span class="o">[</span><span class="s1">'response'</span><span class="o">]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">content</span> <span class="o">|</span>
    <span class="nb">puts</span> <span class="n">content</span><span class="o">[</span><span class="s1">'title'</span><span class="o">]</span>
<span class="k">end</span>
</code></pre></div>
<p>Conclusions</p>

<ul>
<li>Ma routine journalière prenait environ 55 minutes. La nouvelle routine, via l&#39;api, dure environ 90 secondes.</li>
<li>J&#39;ai depuis très envie de l&#39;étendre pour ajouter de nouvelles procédures de remises à zéro.</li>
<li>La documentation est primordiale (que ce soit celle de l&#39;API ou celle de OAuth)</li>
</ul>
</div>

	<div class="share">
		<div class="twitter-share">
			<iframe src="http://platform.twitter.com/widgets/tweet_button.html?url=http%3A%2F%2Fblog.fabricebournisien.eu%2F%2F2013%2F06%2F10%2Fruby-oauth-v1.0a-pour-optimiser-les-tests%2F&amp;via=fabrice31&amp;text=Ruby - OAuth v1.0a pour optimiser les tests&amp;lang=fr&amp;count=horizontal" frameborder="0" allowTransparency="1" scrolling="no" style="height:20px;width:133px;"></iframe>
		</div>
		<div class="facebook-share">
			<iframe src="//www.facebook.com/plugins/like.php?href=http://blog.fabricebournisien.eu//2013/06/10/ruby-oauth-v1.0a-pour-optimiser-les-tests/&amp;send=false&amp;layout=button_count&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font" frameborder="0" allowTransparency="1" scrolling="no" style="height:20px;width:133px;"></iframe>
		</div>
		<div class="google-share">
			<iframe src="https://plusone.google.com/u/0/_/+1/fastbutton?url=http://blog.fabricebournisien.eu//2013/06/10/ruby-oauth-v1.0a-pour-optimiser-les-tests/&amp;size=medium&amp;annotation=bubble&amp;lang=fr" frameborder="0" allowTransparency="1" scrolling="no" style="height:20px;width:90px;"></iframe>
		</div>
	</div>

</div>

<script src="https://apis.google.com/js/plusone.js"></script>
<div class="g-comments"
    data-href="http://blog.fabricebournisien.eu//2013/06/10/ruby-oauth-v1.0a-pour-optimiser-les-tests/"
    data-width="642"
    data-first_party_property="BLOGGER"
    data-view_type="FILTERED_POSTMOD">
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="http://blog.fabricebournisien.eu//2013/02/26/tester-sur-plusieurs-navigateurs/">
            Tester sur plusieurs navigateurs
            <small>26 Feb 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="http://blog.fabricebournisien.eu//2013/06/17/affichage-des-resultats-de-tests/">
            Affichage des résultats de tests
            <small>17 Jun 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="http://blog.fabricebournisien.eu//2013/03/18/quand-un-commercant-en-ligne-a-des-bugs/">
            Quand un commerçant en ligne a des bugs
            <small>18 Mar 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
    </div>
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53219654-1', 'auto');
  ga('send', 'pageview');

</script>
	
	<script>
	$('.post img').each(function() {
		$(this).wrap("<a class='fancybox' rel='gallery' href='" + this.src + "'/>");
	});
	$(".fancybox").attr('rel', 'gallery').fancybox({
		beforeShow : function() {
			var alt = this.element.find('img').attr('alt');
			this.inner.find('img').attr('alt', alt);
			this.title = alt;
		},
		helpers : {
			title: {
				type: 'inside',
				position: 'bottom'
			}
		},
        openEffect  : 'fade',
        closeEffect : 'fade',
        nextEffect  : 'none',
        prevEffect  : 'none',
        padding     : 0,
        margin      : [20, 60, 20, 60] // Increase left/right margin
	});
	</script>

  </body>
</html>
